# 区块基础-PAXOS

标签（空格分隔）： 磨链输出计划

---

谈到区块链都会说到分布式系统，分布式系统的概念很早之前就被提了出来，因为CAP原则，随着分布式系统的出现需要一种高度容错的分布式算法来保证系统高效稳定的运行、特别是分布式系统的中一致性问题，无法决定一致性问题，那么分布式系统的存在现实应用意义及不会太大。
我们常用的数据库复制切换模式，主库备库就面临这样的一个问题。不管是现在流行的oracle数据库还是最近很火热的mysql数据库，在作为重要应用系统的系统数据库的时候，很多时候开发业务的团队都会要求做数据冗余，甚至数据的实时保护，那么这时候设计数据库架构的时候就会考虑一主一备模式，或者是一主多备模式，如果你的业务系统RTO\RPO要求很高的话，数据要保证强一致性。那么就有强同步模式，要求主的设备必须把redolog同步至备份，甚至多台备机，完成后才能响应客户端，这个时候要求多台主备机正常运行，主备机之间的网络状况要相当理想而且稳定。但是考虑下很多时候备份设备要是距离主数据中心有很长一段距离呢，即使用上波分设备，中间的链路是不是还会出现其他各种意外情况（施工中断等），那么主备之间没有同步完成就一直会影响到前台的响应。当然可以做异步复制，但是异步肯定存在数据的一段时间的缺失，出现意外情况不可避免要丢失数据。这种模式就需要应用业务部门的取舍。
![屏幕快照 2018-05-11 下午10.15.20.png-419kB][1]


这里引入PAXOS算法，该算法目前公认是解决分布式一致性问题的最有效的算法之一，由莱斯利·兰伯特（Leslie Lamport）在1990年提出一种基于消息传递的一致性算法。该算法的目的最直接的作用就是解决一个分布式系统如何对一个值的操作（更改、生成、生效等）达成一致。

对分布式算法的研究1980就开始了，通过节点通信保障一致性问题上，存在两种模式：共享内存（Shared memory）和消息传递（Messages passing），PAXOS就是后者。有兴趣的可以看下下面两个论文，论文有点绕有一个还未全部翻译：paxos made simple https://wenku.baidu.com/view/602c3531f111f18583d05a9e.html。The Part-Time Parliament：https://wenku.baidu.com/view/87276e1dfad6195f312ba6d7.html

PAXOS算法：在分布式系统中，存在分布式节点，节点于节点之间通过网络传输，终端设备访问系统。
![屏幕快照 2018-05-11 下午10.15.32.png-540.6kB][2]
 

那么节点间的通讯数据同步这里称为消息传递。由于分布式系统不可避免的故障点原因（网络延时、主机宕机、数据传输过程丢失等），需要一个算法对分布式系统达成共识，在PAXOS（这个算法是基于一个小岛上议会的场景提出）算法中引入三个角色和一些流程号：

* Proposer：提案者（提出某个议案）

* Acceptor：接受者（接受提出者的议案）

* Learners：学习者（学习实施议案）

引入节点议案本地编号：PID

议案值：value

三种绝对对于节点来说可以是复用，前提每个节点执行议案过程中可能出现问题，但是船体的议案值value不会被更改。下面用通俗的说话来这个算法，想了解更深入的可以看笔者上面的两个论文链接。

1.分布式节点存在于一个网络环境中，大家网络互通。

2.每个节点对自己本地的议案有一个数据编号，初始化每个节点PID=0。

3.节点A提出议案value，作为提案者，接受者接受value。这里有两种情况，接受者只有一个的话，那么只要接受者接受了value很快就个议案就成立了，那么要是这个接受者出现网络故障或者本身宕机了，那么就马上执行不下去了。那么接受者有多个呢，提案者有多个呢，那么接受者应该怎么接受提案，或者多个接受者接受了不同了提案者的value值怎么处理。算法中设定，接受者必须接受第一个提案。

4.结合PID和value，两个值组合一个数据。

5.节点A已提出议案value，加上PID，PID一直增加，网络中接受者超过半数接受到节点A的提案，这个节点生效，如果稍后时刻节点B提出议案PID值大于目前PID值，那么通过接受者数量超过半数，该议案生效，如果一开始检测PID小于之前PID就被退回，并告诉节点B。

6.学习者去收集接受者接收后的天，且遵循超过半数的原则形成最终的提案，更新value。
![屏幕快照 2018-05-11 下午10.15.40.png-558.1kB][3]
 

当然这个只是纯文字说明了PAXOS算法，具体根据流程来解释一遍：

Step-1：提议阶段

节点A选择PID=10，发送10+value的提议请求

接受节点收到10+value，查看本地PID：PID>10,提议被退回。PID<10，先向提议者说明不再接受小于10的提案，查看之前收到过的提案，确定提案把提案中PID最大值发送给节点A。
![屏幕快照 2018-05-11 下午10.15.48.png-366.4kB][4]
 

Step-2：接受阶段

节点A收到接受节点的回复，逐条处理，如果是接受议案的回复就记录PID。

节点A计算拒绝和接受的节点数，如果是拒绝那就准备下一次提案，如果是接受那就选择回复PID中最大值作为自己的提案，如果没有就使用自己提案的PID（这里是10）。然后发送给接受节点

接受节点就相对来说简单，查看自己的PID是否和节点A一致，一致则接受，不一致就拒绝。接下来就发送提案给学习者

学习者在这个阶段保留提案PID，然后根据接受节点接收的数量，如果超过一半就形成共识。
![屏幕快照 2018-05-11 下午10.15.54.png-341.1kB][5]

这里大致介绍了下PAXOS算法，现在针对PAXOS算法也有很过改进，这里只是介绍了最基础的


  [1]: http://static.zybuluo.com/JackyJin/usljdxlb71p096hm7hkum8j0/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-05-11%20%E4%B8%8B%E5%8D%8810.15.20.png
  [2]: http://static.zybuluo.com/JackyJin/hfnsuaqa27koau0ug55e3a03/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-05-11%20%E4%B8%8B%E5%8D%8810.15.32.png
  [3]: http://static.zybuluo.com/JackyJin/nbgqckc833pvp39c9hipe1cu/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-05-11%20%E4%B8%8B%E5%8D%8810.15.40.png
  [4]: http://static.zybuluo.com/JackyJin/83hc09y1neuqek9w3xfimjve/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-05-11%20%E4%B8%8B%E5%8D%8810.15.48.png
  [5]: http://static.zybuluo.com/JackyJin/oqthgaxtfjgfjfft15cknzj3/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-05-11%20%E4%B8%8B%E5%8D%8810.15.54.png
